---
# This playbook sets up the first PXC node from Percona main repo

- hosts: all
  become: true
  become_method: sudo

  tasks:
  - name: include tasks for test env setup
    include: ../tasks/test_prep.yml

  - name: include tasks for enabling main repo
    include: ../tasks/enable_main_repo.yml

  - name: install PXC 5.7 previous deb packages
    apt: name={{item}} update_cache=yes
    with_items:
    - percona-xtradb-cluster-full-57
    when: ansible_os_family == "Debian"

  - name: install PXC 5.7 previous rpm packages
    yum: name={{item}} state=latest
    with_items:
    - Percona-XtraDB-Cluster-full-57
    when: ansible_os_family == "RedHat"

  # stop mysql service
  - service: name=mysql pattern=/usr/bin/mysqld_safe state=stopped

  - name: configure PXC
    template: src=/home/hrvoje/worktable/package-testing/templates/my.j2
              dest=/etc/mysql/my.cnf
              mode=0640 owner=mysql group=root

  #bootstrap the cluster
  - command: service mysql bootstrap-pxc

  #add sstuser
  - mysql_user: name=sstuser password=s3cretPass priv="*.*:RELOAD,PROCESS,LOCK TABLES,REPLICATION CLIENT" state=present
  - command: /vagrant/plugins_test_57.sh
